# Elasticsearch 数据导入运行指南

本指南将帮助您完成 Elasticsearch 的连接测试、索引创建和数据导入。

## 前置要求

### 1. Python 环境
确保已安装 Python 3.7 或更高版本。

### 2. 依赖包安装
在项目根目录或 `实体链接` 目录下运行以下命令安装依赖：

```bash
pip install elasticsearch tqdm beautifulsoup4
```

## 运行步骤

### 步骤 1: 测试 ES 连接有效性

运行测试脚本，验证 Elasticsearch 连接是否正常：

```bash
# 在 实体链接 目录下运行
python testes/test_es_aliyun.py
```

**预期输出：**
- ✓ 连接成功 - ES版本: x.x.x
- ✓ 索引创建成功
- ✓ 成功写入 X 条文档
- ✓ 查询成功，找到 X 条结果

**如果连接失败：**
- 检查 `es_client.py` 中的 ES_URL、ES_USERNAME、ES_PASSWORD 配置是否正确
- 确认网络连接正常
- 确认阿里云 ES 服务状态正常

### 步骤 2: 创建索引

运行索引创建脚本，建立数据索引结构：

```bash
# 在 实体链接 目录下运行
python createES.py
```

**预期输出：**
- 成功创建索引

**说明：**
- 脚本会删除已存在的 `data2` 索引（如果存在）
- 创建新的 `data2` 索引，包含以下字段映射：
  - `label`: 实体标签（支持拼音、IK分词、缩写搜索）
  - `link`: 维基百科链接
  - `aliases_en`: 英文别名
  - `aliases_zh`: 中文别名
  - `descriptions_en`: 英文描述
  - `descriptions_zh`: 中文描述
  - `descriptions_en_vector`: 英文描述向量（1024维）
  - `descriptions_zh_vector`: 中文描述向量（1024维）
  - `content`: 内容（支持拼音、IK分词、缩写搜索）
  - `content_vector`: 内容向量（1024维）

### 步骤 3: 导入数据

运行数据导入脚本，将数据导入到 Elasticsearch：

```bash
# 在 实体链接 目录下运行
python toesdata.py
```

**预期输出：**
- 找到数据文件: xxx.jsonl
- 文件总行数: XXXX
- 开始导入数据，批次大小: 100...
- 导入进度条显示
- 导入完成统计信息

**数据文件查找顺序：**
脚本会按以下顺序查找数据文件：
1. `zh_wiki_v2.jsonl` (当前目录)
2. `中英文维基-部分/zh_wiki_v2.jsonl`
3. `../中英文维基-部分/zh_wiki_v2.jsonl`
4. `data2.jsonl`

**导入配置：**
- 批次大小: 100 条/批
- 请求超时: 120 秒
- 单条数据大小限制: 1MB
- 批次总大小限制: 5MB

**注意事项：**
- 如果数据文件不存在，脚本会提示错误并退出
- 导入过程会显示进度条和详细日志
- 如果部分数据导入失败，会显示错误信息但不会中断整个导入过程
- 向量字段只有在维度为 1024 时才会被导入

## 快速运行方式

### 方式一：使用批处理脚本（推荐）

**Windows 用户：**
直接双击 `运行脚本.bat` 或在命令行中运行：
```cmd
运行脚本.bat
```

**Linux/Mac 用户：**
```bash
chmod +x 运行脚本.sh
./运行脚本.sh
```

批处理脚本会自动按顺序执行所有步骤，并在任何步骤失败时停止。

### 方式二：手动运行

在 Windows PowerShell 中：

```powershell
# 切换到实体链接目录
cd 实体链接

# 步骤 1: 测试连接
python testes\test_es_aliyun.py

# 步骤 2: 创建索引
python createES.py

# 步骤 3: 导入数据
python toesdata.py
```

在 Linux/Mac 终端中：

```bash
# 切换到实体链接目录
cd 实体链接

# 步骤 1: 测试连接
python testes/test_es_aliyun.py

# 步骤 2: 创建索引
python createES.py

# 步骤 3: 导入数据
python toesdata.py
```

## 配置文件说明

### es_client.py
Elasticsearch 客户端配置文件，包含：
- `ES_URL`: Elasticsearch 服务地址
- `ES_USERNAME`: 用户名
- `ES_PASSWORD`: 密码

**重要：** 请确保这些配置信息正确，否则无法连接到 Elasticsearch。

## 常见问题

### 1. 连接失败
- **问题**: 提示连接错误或认证失败
- **解决**: 检查 `es_client.py` 中的配置信息是否正确

### 2. 索引已存在
- **问题**: 创建索引时提示索引已存在
- **解决**: `createES.py` 会自动删除已存在的索引，如果仍有问题，可以手动删除索引

### 3. 数据导入失败
- **问题**: 部分数据导入失败
- **解决**: 
  - 检查数据文件格式是否正确（JSONL 格式）
  - 检查向量维度是否为 1024（如果不是，会被自动跳过）
  - 查看错误日志了解具体原因

### 4. 导入速度慢
- **问题**: 数据导入速度较慢
- **解决**: 
  - 可以调整 `toesdata.py` 中的 `batch_size` 参数（默认 100）
  - 注意：批次大小过大会导致请求超时或超过大小限制

## 索引结构说明

创建的 `data2` 索引包含以下分析器：

1. **pinyin_analyzer**: 拼音分析器，支持拼音搜索
2. **ik_smart_analyzer**: IK 智能分词器，支持中文分词
3. **abbreviation_analyzer**: 缩写分析器，支持缩写匹配

每个文本字段都支持多种搜索方式：
- 默认搜索
- 拼音搜索（`.pinyin`）
- IK 分词搜索（`.ik`）
- 缩写搜索（`.abbreviation`）

## 数据格式要求

导入的数据文件应为 JSONL 格式（每行一个 JSON 对象），包含以下字段：

```json
{
  "label": "实体名称",
  "wikipedia": "或wikipediaLink": "维基百科链接",
  "en_aliases": ["英文别名1", "英文别名2"],
  "zh_aliases": ["中文别名1", "中文别名2"],
  "en_description": "英文描述",
  "zh_description": "中文描述",
  "descriptions_en_vector": [1024维向量],
  "descriptions_zh_vector": [1024维向量],
  "content": "内容（可以是HTML）"
}
```

## 验证导入结果

导入完成后，可以通过以下方式验证：

1. 使用 Elasticsearch API 查询：
```python
from 实体链接.es_client import es

# 查询索引中的文档数量
result = es.count(index="data2")
print(f"文档总数: {result['count']}")

# 查询前10条数据
result = es.search(index="data2", body={"query": {"match_all": {}}, "size": 10})
print(f"查询结果: {result['hits']['total']['value']} 条")
```

2. 使用 Kibana 或阿里云 ES 控制台查看索引和数据

## 技术支持

如遇到问题，请检查：
1. Python 版本和依赖包是否正确安装
2. Elasticsearch 连接配置是否正确
3. 数据文件格式是否符合要求
4. 网络连接是否正常

