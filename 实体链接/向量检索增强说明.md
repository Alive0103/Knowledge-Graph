# 向量检索增强功能说明

## 功能概述

已成功实现向量检索增强功能，将文本检索（BM25）与向量检索（KNN）相结合，提升实体链接的召回率和准确性。

## 主要改进

### 1. 向量生成优化

- **L2归一化**：所有生成的向量都经过L2归一化处理，确保向量在单位球面上，提高相似度计算的准确性
- **维度处理**：自动处理768维模型到1024维ES字段的转换（通过零填充）
- **向量缓存**：实现了LRU缓存机制，最多缓存1000个查询向量，减少重复计算

### 2. 混合检索架构

- **文本检索**：继续使用BM25算法匹配`label`和`aliases_zh`字段（boost=1.0）
- **向量检索**：使用KNN查询检索向量字段（boost=0.8）
- **智能回退**：
  - 优先使用`content_vector`字段（包含完整页面内容）
  - 如果`content_vector`不存在或失败，自动回退到`descriptions_zh_vector`
  - 如果向量检索完全失败，自动回退到纯文本检索

### 3. 查询向量生成

- **使用LLM规范化定义**：优先使用LLM生成的规范化定义生成查询向量
- **回退机制**：如果LLM失败，使用原始查询文本生成向量
- **批处理优化**：支持批量向量化，提升处理效率

## 使用方法

### 基本使用

```python
from search_withllm import hybrid_search

# 使用默认参数（启用向量检索）
results = hybrid_search("F-22战斗机", top_k=20)

# 禁用向量检索（仅文本检索）
results = hybrid_search("F-22战斗机", top_k=20, use_vector=False)

# 自定义权重
results = hybrid_search("F-22战斗机", top_k=20, text_boost=1.2, vector_boost=0.9)
```

### 参数说明

- `query_text`: 查询文本
- `top_k`: 返回结果数量（默认20）
- `text_boost`: 文本检索的boost权重（默认1.0）
- `vector_boost`: 向量检索的boost权重（默认0.8）
- `use_vector`: 是否使用向量检索（默认True）

## 技术细节

### 向量生成流程

1. 输入文本 → Chinese-RoBERTa模型 → [CLS] token向量（768维）
2. L2归一化
3. 零填充到1024维（如果模型是768维）
4. 重新L2归一化
5. 返回1024维向量列表

### 混合检索查询结构

```python
{
    "query": {
        "bool": {
            "should": [
                {"match": {"label": {"query": "...", "boost": 1.0}}},
                {"match": {"aliases_zh": {"query": "...", "boost": 1.0}}}
            ]
        }
    },
    "knn": {
        "field": "content_vector",
        "query_vector": [1024维向量],
        "k": 10,
        "num_candidates": 20,
        "boost": 0.8
    },
    "size": 20
}
```

### 得分融合

Elasticsearch自动将文本检索和向量检索的得分进行归一化后加权求和：
- 文本得分 × text_boost
- 向量得分 × vector_boost
- 最终得分 = 归一化后的加权和

## 性能优化

### 向量缓存

- 使用字典缓存，最多缓存1000个查询向量
- FIFO策略：缓存满时删除最旧的条目
- 显著减少重复计算，特别是对于常见查询

### 错误处理

- LLM失败 → 使用原始查询文本生成向量
- 向量生成失败 → 回退到纯文本检索
- content_vector失败 → 回退到descriptions_zh_vector
- descriptions_zh_vector失败 → 回退到纯文本检索

## 预期效果

- **召回率提升**：特别是对语义相似但关键词不匹配的实体
- **Hits@10提升**：预计提升3-5%
- **语义理解**：能够匹配同义词、近义词和语义相关实体

## 注意事项

1. **模型维度**：
   - **推荐**：使用 `chinese-roberta-wwm-ext-large`（1024维），与ES向量字段维度完全匹配，无需转换
   - **备选**：使用 `chinese-roberta-wwm-ext`（768维），会自动零填充扩展到1024维
   - 代码会自动检测模型维度并处理

2. **向量字段**：确保ES索引中存在`content_vector`或`descriptions_zh_vector`字段，且向量维度为1024。

3. **性能**：向量检索会增加查询时间，但通过缓存机制可以显著减少重复计算。

4. **权重调优**：可以通过网格搜索在验证集上测试不同权重组合，选择最优参数。

## 后续优化建议

1. **使用1024维模型**：✅ 已完成 - 使用chinese-roberta-wwm-ext-large模型，无需零填充
2. **权重调优**：在验证集上测试不同权重组合（text_boost: 0.8-1.2, vector_boost: 0.6-1.0）
3. **批量向量化**：对多个查询进行批量向量化，提升处理效率
4. **向量索引优化**：使用HNSW算法构建向量索引，平衡检索精度与速度

