# 完整操作流程：从文本插入ES到对比评估

## 概述

本文档提供从将wiki文本内容插入ES索引开始，到完成添加前后效果对比评估的完整操作流程。

## 前置条件检查

在执行操作前，请确认：

1. ✅ **ES服务已启动**：确保Elasticsearch服务正常运行
2. ✅ **文本文件已下载**：`work_wyy/data/find_wiki_content/` 目录下有txt文件
3. ✅ **find.xlsx文件存在**：`work_wyy/data/find.xlsx` 文件存在且格式正确
4. ✅ **Python环境配置**：相关依赖包已安装

## 完整操作步骤

### 步骤1: 测评添加wiki内容前的文本检索效果（基线）

**目的**：获取添加wiki内容前的基线性能指标

```bash
# 进入local目录
cd work_wyy/local

# 执行测评（使用你实际的索引名称）
python evaluate_with_wiki_content.py --index data_config_5_all_except_msra --output trainlog/eval_before_wiki.json
```

**说明**：
- `--index`: 指定要测评的ES索引名称（必须与后续步骤使用相同的索引）
- `--output`: 指定输出报告文件路径（建议使用 `eval_before_wiki.json` 便于后续对比）

**预期输出**：
```
======================================================================
使用模式2（es_text_only）测评包含wiki文本内容的ES索引
======================================================================
find.xlsx文件: D:\work\毕设\知识图谱\Knowledge-Graph\work_wyy\data\find.xlsx
ES索引: data_config_5_all_except_msra
检索模式: es_text_only (模式2 - 纯文本检索)
======================================================================
从 ... 读取了 444 个有效查询-链接对

开始测评，共 444 个查询...
注意: 使用纯文本检索模式，不涉及向量检索和LLM重排序
检索对比: 100%|████████████████████████████████████████| 444/444 [02:15<00:00,  3.28it/s]

======================================================================
测评结果
======================================================================
检索模式: es_text_only (模式2 - 纯文本检索)
ES索引: data_config_5_all_except_msra
总查询数: 444
MRR: 0.6500
Hit@1: 0.5800 (58.00%)
Hit@5: 0.7200 (72.00%)
Hit@10: 0.7800 (78.00%)
======================================================================

测评报告已保存到: .../trainlog/eval_before_wiki.json
======================================================================
```

**重要**：记录下这个基线结果，后续将用于对比。

---

### 步骤2: 将wiki文本内容插入ES索引

**目的**：将下载的wiki文本内容存储到ES索引中

```bash
# 确保在local目录下
cd work_wyy/local

# 执行文本插入（使用与步骤1相同的索引名称）
python store_wiki_content_to_es.py --index data_config_5_all_except_msra
```

**说明**：
- `--index`: 必须与步骤1和步骤3使用相同的索引名称
- `--content-dir`: 可选，默认使用 `work_wyy/data/find_wiki_content`
- `--match-existing`: 默认True，会更新现有文档（推荐）

**预期输出**：
```
======================================================================
将wiki文本内容存储到ES索引（文本检索模式）
======================================================================
内容目录: D:\work\毕设\知识图谱\Knowledge-Graph\work_wyy\data\find_wiki_content
目标索引: data_config_5_all_except_msra
注意: 只存储文本内容，不生成向量
======================================================================

开始处理目录: ...
目标索引: data_config_5_all_except_msra
匹配模式: 更新现有文档
注意: 只存储文本内容，不生成向量（用于文本检索测评）
======================================================================
找到 444 个txt文件
处理文件: 100%|████████████████████████████████████████| 444/444 [00:45<00:00,  9.82it/s]

======================================================================
处理完成统计
======================================================================
总文件数: 444
成功: 444 个
失败: 0 个
成功率: 100.0%

索引 data_config_5_all_except_msra 当前文档数: 1234
======================================================================
✓ 完成！
======================================================================
```

**验证**：检查输出中的"成功"数量，确保所有文件都已成功插入。

---

### 步骤3: 测评添加wiki内容后的文本检索效果

**目的**：获取添加wiki内容后的性能指标

```bash
# 确保在local目录下
cd work_wyy/local

# 执行测评（使用与步骤1和步骤2相同的索引名称）
python evaluate_with_wiki_content.py --index data_config_5_all_except_msra --output trainlog/eval_after_wiki.json
```

**说明**：
- `--index`: 必须与步骤1和步骤2使用相同的索引名称
- `--output`: 指定输出报告文件路径（建议使用 `eval_after_wiki.json` 便于后续对比）

**预期输出**：
```
======================================================================
使用模式2（es_text_only）测评包含wiki文本内容的ES索引
======================================================================
find.xlsx文件: D:\work\毕设\知识图谱\Knowledge-Graph\work_wyy\data\find.xlsx
ES索引: data_config_5_all_except_msra
检索模式: es_text_only (模式2 - 纯文本检索)
======================================================================
从 ... 读取了 444 个有效查询-链接对

开始测评，共 444 个查询...
注意: 使用纯文本检索模式，不涉及向量检索和LLM重排序
检索对比: 100%|████████████████████████████████████████| 444/444 [02:15<00:00,  3.28it/s]

======================================================================
测评结果
======================================================================
检索模式: es_text_only (模式2 - 纯文本检索)
ES索引: data_config_5_all_except_msra
总查询数: 444
MRR: 0.7234
Hit@1: 0.6568 (65.68%)
Hit@5: 0.7919 (79.19%)
Hit@10: 0.8189 (81.89%)
======================================================================

测评报告已保存到: .../trainlog/eval_after_wiki.json
======================================================================
```

**对比观察**：可以初步对比步骤1和步骤3的输出，查看指标是否有提升。

---

### 步骤4: 自动对比评估结果

**目的**：自动对比添加wiki前后的测评结果，生成详细的对比报告

```bash
# 确保在local目录下
cd work_wyy/local

# 执行对比（使用步骤1和步骤3生成的报告文件）
python compare_wiki_evaluation.py --before trainlog/eval_before_wiki.json --after trainlog/eval_after_wiki.json
```

**说明**：
- `--before`: 步骤1生成的报告文件路径
- `--after`: 步骤3生成的报告文件路径
- `--output`: 可选，指定对比报告输出路径（默认自动生成）

**预期输出**：
```
======================================================================
加载测评报告
======================================================================
添加前报告: .../trainlog/eval_before_wiki.json
添加后报告: .../trainlog/eval_after_wiki.json

======================================================================
添加Wiki内容前后文本检索效果对比
======================================================================

【测评信息】
  添加前索引: data_config_5_all_except_msra
  添加前时间: 2025-12-15T10:00:00
  添加后索引: data_config_5_all_except_msra
  添加后时间: 2025-12-15T10:30:00
  查询总数: 444

【指标对比】
  指标            添加前        添加后        绝对提升      相对提升      
  ----------------------------------------------------------------------
  MRR             0.6500       0.7234        +0.0734       +11.28%      ↑
  Hit@1           0.5800       0.6568        +0.0768       +13.24%      ↑
  Hit@5           0.7200       0.7919        +0.0719       +9.99%       ↑
  Hit@10          0.7800       0.8189        +0.0389       +4.99%       ↑

  ----------------------------------------------------------------------

【总结】
  提升的指标数: 4/4
  MRR相对提升: +11.28%
  Hit@1相对提升: +13.24%
  ✓ 添加wiki内容后，文本检索效果有所提升
======================================================================

对比报告已保存到: .../trainlog/comparison_wiki_20251215_103045.json
======================================================================
```

**结果解读**：
- **↑** 表示指标提升
- **↓** 表示指标下降
- **=** 表示指标不变
- 相对提升百分比显示提升幅度

---

## 一键执行脚本（可选）

如果你想要一次性执行所有步骤，可以创建一个批处理脚本：

### Windows (batch文件)

创建 `run_full_evaluation.bat`：

```batch
@echo off
echo ======================================================================
echo 完整评估流程：从文本插入到对比评估
echo ======================================================================

set INDEX_NAME=data_config_5_all_except_msra

echo.
echo [步骤1/4] 测评添加wiki内容前的效果...
python evaluate_with_wiki_content.py --index %INDEX_NAME% --output trainlog/eval_before_wiki.json
if errorlevel 1 (
    echo 错误: 步骤1失败
    pause
    exit /b 1
)

echo.
echo [步骤2/4] 插入wiki文本内容到ES...
python store_wiki_content_to_es.py --index %INDEX_NAME%
if errorlevel 1 (
    echo 错误: 步骤2失败
    pause
    exit /b 1
)

echo.
echo [步骤3/4] 测评添加wiki内容后的效果...
python evaluate_with_wiki_content.py --index %INDEX_NAME% --output trainlog/eval_after_wiki.json
if errorlevel 1 (
    echo 错误: 步骤3失败
    pause
    exit /b 1
)

echo.
echo [步骤4/4] 对比评估结果...
python compare_wiki_evaluation.py --before trainlog/eval_before_wiki.json --after trainlog/eval_after_wiki.json
if errorlevel 1 (
    echo 错误: 步骤4失败
    pause
    exit /b 1
)

echo.
echo ======================================================================
echo ✓ 完整评估流程执行完成！
echo ======================================================================
pause
```

### Linux/Mac (shell脚本)

创建 `run_full_evaluation.sh`：

```bash
#!/bin/bash

echo "======================================================================"
echo "完整评估流程：从文本插入到对比评估"
echo "======================================================================"

INDEX_NAME="data_config_5_all_except_msra"

echo ""
echo "[步骤1/4] 测评添加wiki内容前的效果..."
python evaluate_with_wiki_content.py --index "$INDEX_NAME" --output trainlog/eval_before_wiki.json
if [ $? -ne 0 ]; then
    echo "错误: 步骤1失败"
    exit 1
fi

echo ""
echo "[步骤2/4] 插入wiki文本内容到ES..."
python store_wiki_content_to_es.py --index "$INDEX_NAME"
if [ $? -ne 0 ]; then
    echo "错误: 步骤2失败"
    exit 1
fi

echo ""
echo "[步骤3/4] 测评添加wiki内容后的效果..."
python evaluate_with_wiki_content.py --index "$INDEX_NAME" --output trainlog/eval_after_wiki.json
if [ $? -ne 0 ]; then
    echo "错误: 步骤3失败"
    exit 1
fi

echo ""
echo "[步骤4/4] 对比评估结果..."
python compare_wiki_evaluation.py --before trainlog/eval_before_wiki.json --after trainlog/eval_after_wiki.json
if [ $? -ne 0 ]; then
    echo "错误: 步骤4失败"
    exit 1
fi

echo ""
echo "======================================================================"
echo "✓ 完整评估流程执行完成！"
echo "======================================================================"
```

使用方式：
```bash
# Windows
run_full_evaluation.bat

# Linux/Mac
chmod +x run_full_evaluation.sh
./run_full_evaluation.sh
```

---

## 常见问题排查

### Q1: 步骤1执行失败，提示"索引不存在"

**A**: 这是正常的。步骤1是在添加wiki内容前测评，索引应该已经存在（包含基础数据）。如果索引确实不存在，请先创建索引并导入基础数据。

### Q2: 步骤2执行后，成功率不是100%

**A**: 检查：
1. txt文件格式是否正确（包含元数据头部）
2. ES服务是否正常运行
3. 索引映射是否正确
4. 查看错误日志了解具体失败原因

### Q3: 步骤3和步骤1的结果完全一样

**A**: 可能原因：
1. wiki内容没有成功插入（检查步骤2的输出）
2. 使用了不同的索引名称
3. ES索引映射中 `wiki_content` 字段未正确添加

### Q4: 对比结果显示指标下降

**A**: 可能原因：
1. wiki内容质量不高或与查询不匹配
2. 搜索权重设置不合理（可以调整 `search_vllm.py` 中的权重）
3. 数据量增加导致噪声增加

---

## 输出文件说明

执行完整流程后，会在 `work_wyy/trainlog/` 目录下生成以下文件：

1. **`eval_before_wiki.json`**: 添加wiki前的测评报告
2. **`eval_after_wiki.json`**: 添加wiki后的测评报告
3. **`comparison_wiki_*.json`**: 自动生成的对比报告

这些文件可以用于：
- 后续分析
- 报告生成
- 结果存档

---

## 总结

完整操作流程包括4个步骤：

1. ✅ **测评基线** → 获取添加前的性能指标
2. ✅ **插入文本** → 将wiki内容存储到ES
3. ✅ **测评效果** → 获取添加后的性能指标
4. ✅ **对比评估** → 自动生成对比报告

**关键点**：
- 所有步骤必须使用**相同的索引名称**
- 确保步骤顺序正确（先测评前，再插入，再测评后）
- 检查每个步骤的输出，确保成功执行

完成这4个步骤后，你就可以清楚地看到添加wiki文本内容对文本检索效果的提升情况了！
